<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Vaga</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Estilos Gerais */
    .remove-btn {
      color: #ef4444;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    select[multiple] {
      height: 150px;
    }
    .optional {
      color: #6b7280;
      font-style: italic;
      font-size: 0.875rem;
    }
    .valid {
      border-color: #22c55e;
    }
    .invalid {
      border-color: #ef4444;
    }
    /* Estilos para a busca de vagas */
    #search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        position: absolute;
        background-color: white;
        width: calc(100% - 2px); /* Ajustar à largura do input */
        z-index: 10;
    }
    .search-result-item {
        padding: 0.75rem;
        cursor: pointer;
    }
    .search-result-item:hover {
        background-color: #f3f4f6;
    }
    .search-result-item .vacancy-code {
        font-size: 0.8rem;
        color: #6b7280;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Cabeçalho com avisos importantes -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-bullhorn text-blue-500 text-xl mr-3 mt-1"></i>
        </div>
        <div>
          <p class="font-bold text-blue-800"><i class="fas fa-exclamation-circle mr-1"></i> Este formulário garante que sua vaga seja divulgada com rapidez e visibilidade.</p>
          <p class="text-blue-700 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i> Vagas sem esse envio podem demorar mais para irem ao ar.</p>
        </div>
      </div>
    </div>

    <!-- Indicador de Progresso -->
    <div class="flex mb-8 overflow-x-auto">
      <div class="flex space-x-4">
        <div id="step1" class="flex items-center">
          <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white font-bold">1</div>
          <div class="ml-2 text-sm font-medium text-gray-700">Dados Básicos</div>
        </div>
        <div id="step2" class="flex items-center">
          <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold">2</div>
          <div class="ml-2 text-sm font-medium text-gray-700">Impulsionamento</div>
        </div>
      </div>
    </div>
    
    <form id="vagaForm" class="bg-white shadow-md rounded-lg p-6">
      <!-- Seção 1 - Dados da Vaga -->
      <section id="sessao1" class="form-section active">
        <h2 class="text-2xl font-bold text-blue-700 border-b border-blue-200 pb-3 mb-6 flex items-center">
          <i class="fas fa-file-alt mr-2"></i> Sessão 1 - Dados da Vaga
        </h2>

        <div id="unidade-container" class="mb-4">
            <label class="block text-gray-700 font-medium mb-2" for="unidadeRH">Unidade RHBrasil <span class="text-red-500">*</span></label>
            <select id="unidadeRH" name="unidadeRH" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Carregando unidades...</option>
            </select>
        </div>

        <div class="relative mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="cargo">
            Nome do cargo <span class="text-red-500">*</span>
          </label>
          <input id="cargo" name="cargo" type="text" required autocomplete="off"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Informe o nome ou código da vaga...">
          <div id="search-results" class="hidden"></div>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="codigoVaga">
            Código da vaga <span class="text-red-500">*</span>
          </label>
          <input id="codigoVaga" name="codigoVaga" type="text" required maxlength="6" pattern="\d{6}"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Ex: 123456">
        </div>

        <div id="offline-description-container" class="hidden mb-4">
             <div class="flex justify-between items-center">
                <label class="block text-gray-700 font-medium" for="descricaoVaga">
                    Descrição da Vaga (para análise da IA)
                </label>
                <button type="button" id="gemini-parse-btn" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md hover:bg-indigo-200 transition flex items-center">
                    <i class="fas fa-robot mr-2"></i> Analisar com Recrutinha IA
                </button>
            </div>
            <textarea id="descricaoVaga" name="descricaoVaga" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2" placeholder="Cole a descrição completa da vaga aqui..."></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="analista">
            Nome do analista <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Insira o nome completo do analista responsável">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <input id="analista" name="analista" type="text" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="whatsapp">
            WhatsApp <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Insira o número de WhatsApp com DDD">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <input id="whatsapp" name="whatsapp" type="tel" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="divulgaLogo">
            Pode divulgar a logo? <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Selecione se a logo da empresa pode ser divulgada">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <select id="divulgaLogo" name="divulgaLogo" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>
        
        <div id="avisoLogo" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-yellow-500 text-xl mr-3 mt-1"></i>
            </div>
            <div>
              <p class="text-yellow-800">Para melhor divulgação, envie o logo em formato vetorial (AI, SVG ou EPS). Caso não tenha, podemos usar versão JPG/PNG.</p>
            </div>
          </div>
        </div>

        <div id="nomeEmpresaContainer" class="hidden mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="empresa">
            Nome da empresa <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Insira o nome da empresa">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <input id="empresa" name="empresa" type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="producao">
            É produção? <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Selecione se a vaga é para produção">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <select id="producao" name="producao" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div id="avisoMarketing" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-4 rounded">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
            </div>
            <div>
              <p class="text-red-800">O marketing NÃO está permitido divulgar vagas de produção sem logo.</p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="presencial">
            Comparecimento presencial? O padrão é RHBrasil <span class="text-red-500">*</span>
          </label>
          <select id="presencial" name="presencial" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="RHBrasil">RHBrasil</option>
            <option value="Outro">Outro lugar</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="temDataDefinida">
            Tem data de processo seletivo? O padrão é Segunda à Sexta <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Se não tiver data de processo seletivo, o padrão será de Segunda à Sexta.">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <select id="temDataDefinida" name="temDataDefinida" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div id="datasContainer" class="hidden mb-4">
          <div class="tipo-container flex space-x-4 mb-4">
            <label class="inline-flex items-center">
              <input type="radio" name="tipoData" value="unico" checked class="form-radio text-blue-600">
              <span class="ml-2">Data única</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="tipoData" value="intervalo" class="form-radio text-blue-600">
              <span class="ml-2">Intervalo</span>
            </label>
          </div>

          <div id="dataUnica">
            <div id="datasUnicas">
              <div class="campo-data flex items-center mb-2">
                <label class="mr-2">Data:</label>
                <input type="date" name="datas[]"
                  class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="remove-btn ml-2" onclick="removerData(this)"><i class="fas fa-times"></i></span>
              </div>
            </div>
            <button type="button" onclick="adicionarData()"
              class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition">
              <i class="fas fa-plus mr-1"></i> Adicionar data
            </button>
          </div>

          <div id="dataIntervalo" class="hidden">
             <div id="datasIntervalos">
                <div class="campo-intervalo grid grid-cols-5 gap-2 items-center mb-2">
                  <label>De</label>
                  <input type="date" name="dataInicio[]"
                    class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <label>até</label>
                  <input type="date" name="dataFim[]"
                    class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="remove-btn ml-2" onclick="removerIntervalo(this)"><i class="fas fa-times"></i></span>
                </div>
            </div>
            <button type="button" onclick="adicionarIntervalo()"
              class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition">
              <i class="fas fa-plus mr-1"></i> Adicionar intervalo
            </button>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="temHorarioDefinido">
            Tem horário de processo seletivo? O padrão é 7:30 às 17:00 <span class="text-red-500">*</span>
            <span class="text-blue-500 cursor-help ml-1" title="Se não tiver horário definido, o padrão será das 7:30 às 17:00">
              <i class="fas fa-info-circle"></i>
            </span>
          </label>
          <select id="temHorarioDefinido" name="temHorarioDefinido" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div id="horariosContainer" class="hidden mb-4">
          <div class="tipo-container flex space-x-4 mb-4">
            <label class="inline-flex items-center">
              <input type="radio" name="tipoHorario" value="unico" checked class="form-radio text-blue-600">
              <span class="ml-2">Horário único</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="tipoHorario" value="intervalo" class="form-radio text-blue-600">
              <span class="ml-2">Intervalo</span>
            </label>
          </div>

          <div id="horarioUnico">
            <div id="horariosUnicos">
              <div class="campo-horario flex items-center mb-2">
                <label class="mr-2">Horário:</label>
                <input type="time" name="horarios[]"
                  class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="remove-btn ml-2" onclick="removerHorario(this)"><i class="fas fa-times"></i></span>
              </div>
            </div>
            <button type="button" onclick="adicionarHorario()"
              class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition">
              <i class="fas fa-plus mr-1"></i> Adicionar horário
            </button>
          </div>

          <div id="horarioIntervalo" class="hidden">
            <div id="horariosIntervalos">
                <div class="campo-intervalo-horario grid grid-cols-5 gap-2 items-center mb-2">
                  <label>Das</label>
                  <input type="time" name="horaInicio[]"
                    class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <label>às</label>
                  <input type="time" name="horaFim[]"
                    class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <span class="remove-btn ml-2" onclick="removerHorarioIntervalo(this)"><i class="fas fa-times"></i></span>
                </div>
            </div>
             <button type="button" onclick="adicionarHorarioIntervalo()"
              class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition">
              <i class="fas fa-plus mr-1"></i> Adicionar intervalo de horário
            </button>
          </div>
        </div>

        <div id="outroLugar" class="hidden mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="local">
            Local para comparecer (Google Maps link) <span class="text-red-500">*</span>
          </label>
          <input id="local" name="local" type="url" placeholder="https://maps.app.goo.gl/xyz123"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="eventoContainer" class="hidden mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="evento">
            É evento/feirão/mutirão?
          </label>
          <select id="evento" name="evento"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Não">Não</option>
            <option value="Feirão">Feirão</option>
            <option value="Mutirão">Mutirão</option>
            <option value="Vanzinha">Vanzinha</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="recorrente">
            É uma vaga recorrente? <span class="text-red-500">*</span>
          </label>
          <select id="recorrente" name="recorrente" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div id="mediaMensalContainer" class="hidden mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="mediaMensal">
            Qual a média mensal de vagas fechas? <span class="text-red-500">*</span>
          </label>
          <input id="mediaMensal" name="mediaMensal" type="number" 
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="vagas">
            Quantas vagas <span class="text-red-500">*</span>
          </label>
          <input id="vagas" name="vagas" type="number" required placeholder="Ex: 1, 3, 10 ou 400"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="beneficios">
            Benefícios <span class="optional">(Opcional)</span>
          </label>
          <textarea id="beneficios" name="beneficios" rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="requisitos">
            Requisitos <span class="optional">(Opcional)</span>
          </label>
          <textarea id="requisitos" name="requisitos" rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="turnos">
            Turnos <span class="optional">(Opcional)</span>
          </label>
          <input id="turnos" name="turnos" type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="joinville">
            É para Joinville? <span class="text-red-500">*</span>
          </label>
          <select id="joinville" name="joinville" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div id="cidadeOutras" class="hidden mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="outraCidade">
            Qual cidade? <span class="text-red-500">*</span>
          </label>
          <input id="outraCidade" name="outraCidade" type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="notas">
            Notas adicionais (algo que só você sabe e ajuda muito?) <span class="optional">(Opcional)</span>
          </label>
          <textarea id="notas" name="notas" rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div class="mb-6">
          <label class="block text-gray-700 font-medium mb-2" for="impulsionar">
            É para impulsionar? <span class="text-red-500">*</span>
          </label>
          <select id="impulsionar" name="impulsionar" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>

        <div id="avisoImpulsionamento" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3 mt-1"></i>
            </div>
            <div>
              <p class="text-yellow-800">Não recomendamos o impulsionamento para comparecer em menos de 4 dias</p>
            </div>
          </div>
        </div>

        <div class="flex justify-between mt-8">
          <button id="btnFinalizarPDF" type="button" class="px-6 py-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition flex items-center">
            <i class="fas fa-file-pdf mr-2"></i> Finalizar e Salvar PDF
          </button>
          <button id="btnContinuar" type="button" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition flex items-center" style="display: none;">
            Continuar para Impulsionamento <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </section>

      <!-- Seção 2 - Impulsionamento -->
      <section id="sessao2" class="form-section">
        <h2 class="text-2xl font-bold text-blue-700 border-b border-blue-200 pb-3 mb-6 flex items-center">
          <i class="fas fa-rocket mr-2"></i> Sessão 2 - Impulsionamento
        </h2>

        <div id="avisoImpulsionamento4dias" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3 mt-1"></i>
            </div>
            <div>
              <p class="text-yellow-800">Não recomendamos o impulsionamento para comparecer em menos de 4 dias</p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="genero">
            Gênero <span class="text-red-500">*</span>
          </label>
          <select id="genero" name="genero" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Ambos" selected>Ambos</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2" for="idadeMinima">
              Idade mínima <span class="text-red-500">*</span>
            </label>
            <input id="idadeMinima" name="idadeMinima" type="number" value="18" required min="18" max="100"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2" for="idadeMaxima">
              Idade máxima <span class="text-red-500">*</span>
            </label>
            <input id="idadeMaxima" name="idadeMaxima" type="number" value="55" required min="18" max="100"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="dias">
            Quantos dias de impulsionamento? <span class="text-red-500">*</span>
          </label>
          <input id="dias" name="dias" type="number" value="4" required min="1"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="orcamento">
            Qual orçamento sugerido por dia? <span class="text-red-500">*</span>
          </label>
          <input id="orcamento" name="orcamento" type="text" value="R$50,00" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="bairrosJoinvilleContainer" class="mb-6">
          <label class="block text-gray-700 font-medium mb-2" for="bairros">
            Quais bairros? <span class="text-red-500">*</span>
          </label>
          
          <div class="bairros-container bg-white border border-gray-300 rounded-md overflow-hidden">
            <div class="bairros-search p-2 border-b border-gray-300">
              <input type="text" placeholder="Informe o bairro..." id="bairroSearch"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="bairros-list p-2">
              <select multiple="multiple" id="bairros" name="bairros" required
                class="w-full h-40 px-3 py-2 border-none">
                <option value="toda">Toda Joinville</option>
                <optgroup label="CentroNorte">
                  <option value="Centro">Centro</option>
                  <option value="Bom Retiro">Bom Retiro</option>
                  <option value="Pirabeiraba/Centro">Pirabeiraba/Centro</option>
                  <option value="América">América</option>
                  <option value="Atiradores">Atiradores</option>
                  <option value="Costa e Silva">Costa e Silva</option>
                  <option value="Dona Francisca">Dona Francisca</option>
                  <option value="Glória">Glória</option>
                  <option value="Jardim Paraíso">Jardim Paraíso</option>
                  <option value="Jardim Sofia">Jardim Sofia</option>
                  <option value="Rio Bonito">Rio Bonito</option>
                  <option value="Saguaçu">Saguaçu</option>
                  <option value="Santo Antônio">Santo Antônio</option>
                  <option value="Santa Catarina">Santa Catarina</option>
                  <option value="Zona Industrial Norte">Zona Industrial Norte</option>
                </optgroup>
                <optgroup label="Zona Leste">
                  <option value="Aventureiro">Aventureiro</option>
                  <option value="Boa Vista">Boa Vista</option>
                  <option value="Comasa">Comasa</option>
                  <option value="Espinheiros">Espinheiros</option>
                  <option value="Iririú">Iririú</option>
                  <option value="Jardim Iririú">Jardim Iririú</option>
                  <option value="Vila Cubatão">Vila Cubatão</option>
                  <option value="Zona Industrial Tupy">Zona Industrial Tupy</option>
                </optgroup>
                <optgroup label="Zona Sul">
                  <option value="Adhemar Garcia">Adhemar Garcia</option>
                  <option value="Anita Garibaldi">Anita Garibaldi</option>
                  <option value="Boehmerwald">Boehmerwald</option>
                  <option value="Bucarein">Bucarein</option>
                  <option value="Fátima">Fátima</option>
                  <option value="Floresta">Floresta</option>
                  <option value="Guanabara">Guanabara</option>
                  <option value="Itaum">Itaum</option>
                  <option value="Itinga">Itinga</option>
                  <option value="Jarivatuba">Jarivatuba</option>
                  <option value="João Costa">João Costa</option>
                  <option value="Paranaguamirim">Paranaguamirim</option>
                  <option value="Parque Guarani">Parque Guarani</option>
                  <option value="Petrópolis">Petrópolis</option>
                  <option value="Profipo">Profipo</option>
                </optgroup>
                <optgroup label="Zona Oeste">
                  <option value="Morro do Meio">Morro do Meio</option>
                  <option value="Nova Brasília">Nova Brasília</option>
                  <option value="São Marcos">São Marcos</option>
                  <option value="Ulysses Guimarães">Ulysses Guimarães</option>
                  <option value="Vila Nova">Vila Nova</option>
                </optgroup>
              </select>
            </div>
          </div>
        </div>

        <div id="outrosBairrosContainer" class="hidden mb-6">
          <label class="block text-gray-700 font-medium mb-2" for="outrosBairros">
            Quais bairros? <span class="text-red-500">*</span>
          </label>
          <input id="outrosBairros" name="outrosBairros" type="text"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex justify-between mt-8">
          <button type="button" class="px-6 py-3 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 transition flex items-center" onclick="voltarSessao(1)">
            <i class="fas fa-arrow-left mr-2"></i> Voltar
          </button>
          <button type="button" class="px-6 py-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition flex items-center" id="btnSalvarPDF">
            <i class="fas fa-file-pdf mr-2"></i> Finalizar e Salvar PDF
          </button>
        </div>
      </section>

    </form>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let webmailWindow;

    const elementos = {
        form: document.getElementById("vagaForm"),
        // Sessão 1
        unidadeRH: document.getElementById("unidadeRH"),
        analista: document.getElementById("analista"),
        whatsapp: document.getElementById("whatsapp"),
        divulgaLogo: document.getElementById("divulgaLogo"),
        avisoLogo: document.getElementById("avisoLogo"),
        nomeEmpresaContainer: document.getElementById("nomeEmpresaContainer"),
        empresa: document.getElementById("empresa"),
        producao: document.getElementById("producao"),
        avisoMarketing: document.getElementById("avisoMarketing"),
        presencial: document.getElementById("presencial"),
        outroLugar: document.getElementById("outroLugar"),
        local: document.getElementById("local"),
        eventoContainer: document.getElementById("eventoContainer"),
        cargo: document.getElementById("cargo"),
        codigoVaga: document.getElementById("codigoVaga"),
        searchResults: document.getElementById("search-results"),
        unidadeContainer: document.getElementById("unidade-container"),
        recorrente: document.getElementById("recorrente"),
        mediaMensalContainer: document.getElementById("mediaMensalContainer"),
        mediaMensal: document.getElementById("mediaMensal"),
        tipoVaga: document.getElementById("tipoVaga"),
        temDataDefinida: document.getElementById("temDataDefinida"),
        datasContainer: document.getElementById("datasContainer"),
        dataUnica: document.getElementById("dataUnica"),
        datasUnicas: document.getElementById("datasUnicas"),
        dataIntervalo: document.getElementById("dataIntervalo"),
        datasIntervalos: document.getElementById("datasIntervalos"),
        temHorarioDefinido: document.getElementById("temHorarioDefinido"),
        horariosContainer: document.getElementById("horariosContainer"),
        horarioUnico: document.getElementById("horarioUnico"),
        horariosUnicos: document.getElementById("horariosUnicos"),
        horarioIntervalo: document.getElementById("horarioIntervalo"),
        horariosIntervalos: document.getElementById("horariosIntervalos"),
        vagas: document.getElementById("vagas"),
        beneficios: document.getElementById("beneficios"),
        requisitos: document.getElementById("requisitos"),
        turnos: document.getElementById("turnos"),
        notas: document.getElementById("notas"),
        descricaoVaga: document.getElementById("descricaoVaga"),
        offlineDescriptionContainer: document.getElementById("offline-description-container"),
        joinville: document.getElementById("joinville"),
        cidadeOutras: document.getElementById("cidadeOutras"),
        outraCidade: document.getElementById("outraCidade"),
        impulsionar: document.getElementById("impulsionar"),
        avisoImpulsionamento: document.getElementById("avisoImpulsionamento"),
        btnFinalizarPDF: document.getElementById("btnFinalizarPDF"),
        btnContinuar: document.getElementById("btnContinuar"),
        geminiParseBtn: document.getElementById("gemini-parse-btn"),
        
        // Sessão 2
        sessao1: document.getElementById("sessao1"),
        sessao2: document.getElementById("sessao2"),
        avisoImpulsionamento4dias: document.getElementById("avisoImpulsionamento4dias"),
        genero: document.getElementById("genero"),
        idadeMinima: document.getElementById("idadeMinima"),
        idadeMaxima: document.getElementById("idadeMaxima"),
        dias: document.getElementById("dias"),
        orcamento: document.getElementById("orcamento"),
        bairrosJoinvilleContainer: document.getElementById("bairrosJoinvilleContainer"),
        bairroSearch: document.getElementById("bairroSearch"),
        bairros: document.getElementById("bairros"),
        outrosBairrosContainer: document.getElementById("outrosBairrosContainer"),
        outrosBairros: document.getElementById("outrosBairros"),
        btnSalvarPDF: document.getElementById("btnSalvarPDF"),

        // Indicador de Progresso
        step1: document.getElementById('step1').querySelector('div'),
        step2: document.getElementById('step2').querySelector('div'),
    };

    const mascaras = {
        aplicarMascaraTelefone(event) {
            let value = event.target.value.replace(/\D/g, "");
            value = value.substring(0, 11);
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d*)/, "($1) $2");
            } else {
                value = value.replace(/^(\d*)/, "($1");
            }
            event.target.value = value;
        },
        aplicarMascaraValor(event) {
            let value = event.target.value.replace(/\D/g, "");
            if (value === "") {
                event.target.value = "";
                return;
            }
            value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
            event.target.value = value;
        }
    };

    const validacao = {
        validarSessao(numSessao) {
            const sessao = document.getElementById(`sessao${numSessao}`);
            sessao.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            
            const inputs = sessao.querySelectorAll('input[required], select[required], textarea[required]');
            const errors = [];

            const getLabelText = (input) => {
                const label = sessao.querySelector(`label[for="${input.id}"]`);
                if (label) {
                    const clone = label.cloneNode(true);
                    clone.querySelectorAll('span').forEach(s => s.remove());
                    return clone.textContent.trim();
                }
                return input.name || input.id || 'Campo desconhecido';
            };

            inputs.forEach(input => {
                if (input.offsetParent !== null) { 
                    if (!input.value.trim()) {
                        errors.push(`O campo "<b>${getLabelText(input)}</b>" é obrigatório.`);
                        input.classList.add('invalid');
                    }
                }
            });

            const codVagaInput = elementos.codigoVaga;
            if (codVagaInput.offsetParent !== null && codVagaInput.value && !/^\d{6}$/.test(codVagaInput.value)) {
                errors.push(`O <b>Código da vaga</b> deve ser um número de 6 dígitos.`);
                codVagaInput.classList.add('invalid');
            }

            if (numSessao === 1) {
                if (elementos.temDataDefinida.value === 'Sim' && elementos.datasContainer.offsetParent !== null) {
                    const tipoData = document.querySelector('input[name="tipoData"]:checked').value;
                    if (tipoData === 'unico') {
                        const datasInputs = elementos.datasUnicas.querySelectorAll('input[name="datas[]"]');
                        if ([...datasInputs].every(d => !d.value)) {
                            errors.push("Adicione pelo menos uma <b>data</b>.");
                            datasInputs.forEach(d => d.classList.add('invalid'));
                        }
                    } else { 
                        const intervalosInputs = elementos.datasIntervalos.querySelectorAll('.campo-intervalo');
                        if ([...intervalosInputs].some(i => !i.querySelector('input[name="dataInicio[]"]').value || !i.querySelector('input[name="dataFim[]"]').value)) {
                            errors.push("Preencha todos os campos de <b>intervalo de datas</b>.");
                             intervalosInputs.forEach(i => {
                                 if(!i.querySelector('input[name="dataInicio[]"]').value) i.querySelector('input[name="dataInicio[]"]').classList.add('invalid')
                                 if(!i.querySelector('input[name="dataFim[]"]').value) i.querySelector('input[name="dataFim[]"]').classList.add('invalid')
                             });
                        }
                    }
                }
                 if (elementos.temHorarioDefinido.value === 'Sim' && elementos.horariosContainer.offsetParent !== null) {
                    const tipoHorario = document.querySelector('input[name="tipoHorario"]:checked').value;
                    if (tipoHorario === 'unico') {
                         const horariosInputs = elementos.horariosUnicos.querySelectorAll('input[name="horarios[]"]');
                        if ([...horariosInputs].every(h => !h.value)) {
                            errors.push("Adicione pelo menos um <b>horário</b>.");
                            horariosInputs.forEach(h => h.classList.add('invalid'));
                        }
                    } else { 
                        const horariosIntervalosInputs = elementos.horariosIntervalos.querySelectorAll('.campo-intervalo-horario');
                        if ([...horariosIntervalosInputs].some(i => !i.querySelector('input[name="horaInicio[]"]').value || !i.querySelector('input[name="horaFim[]"]').value)) {
                            errors.push("Preencha todos os campos de <b>intervalo de horários</b>.");
                             horariosIntervalosInputs.forEach(i => {
                                 if(!i.querySelector('input[name="horaInicio[]"]').value) i.querySelector('input[name="horaInicio[]"]').classList.add('invalid')
                                 if(!i.querySelector('input[name="horaFim[]"]').value) i.querySelector('input[name="horaFim[]"]').classList.add('invalid')
                             });
                        }
                    }
                }
            }
            
            if (errors.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos Obrigatórios',
                    html: `<div class="text-left">Por favor, preencha os seguintes campos:<br><ul class="list-disc list-inside mt-2">${errors.map(e => `<li>${e}</li>`).join('')}</ul></div>`,
                });
                const firstInvalid = sessao.querySelector('.invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return false;
            }

            return true;
        }
    };

    function updateProgress(step) {
        if (step === 1) {
            elementos.step1.classList.remove('bg-gray-300');
            elementos.step1.classList.add('bg-green-500');
            elementos.step2.classList.remove('bg-green-500');
            elementos.step2.classList.add('bg-gray-300');
        } else if (step === 2) {
            elementos.step2.classList.remove('bg-gray-300');
            elementos.step2.classList.add('bg-green-500');
        }
    }
    
    function navigateTo(sessaoId) {
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sessaoId).classList.add('active');
        const step = sessaoId === 'sessao1' ? 1 : 2;
        updateProgress(step);
    }

    elementos.divulgaLogo.addEventListener('change', (e) => {
        const showEmpresa = e.target.value === 'Sim';
        elementos.avisoLogo.classList.toggle('hidden', !showEmpresa);
        elementos.nomeEmpresaContainer.classList.toggle('hidden', !showEmpresa);
        elementos.empresa.required = showEmpresa;
        if (!showEmpresa) {
            elementos.empresa.value = '';
            elementos.empresa.classList.remove('invalid', 'valid');
        }
        checkMarketingWarning();
    });

    elementos.producao.addEventListener('change', checkMarketingWarning);

    function checkMarketingWarning() {
        const divulga = elementos.divulgaLogo.value;
        const prod = elementos.producao.value;
        elementos.avisoMarketing.classList.toggle('hidden', !(divulga === 'Não' && prod === 'Sim'));
    }

    elementos.presencial.addEventListener('change', (e) => {
        const isOutro = e.target.value === 'Outro';
        elementos.outroLugar.classList.toggle('hidden', !isOutro);
        elementos.eventoContainer.classList.toggle('hidden', !isOutro);
        elementos.local.required = isOutro;
    });
    
    elementos.recorrente.addEventListener('change', (e) => {
      const isRecorrente = e.target.value === 'Sim';
      elementos.mediaMensalContainer.classList.toggle('hidden', !isRecorrente);
      elementos.mediaMensal.required = isRecorrente;
    });

    elementos.temDataDefinida.addEventListener('change', (e) => {
        const show = e.target.value === 'Sim';
        elementos.datasContainer.classList.toggle('hidden', !show);
        checkBoostDateWarning();
    });

    document.querySelectorAll('input[name="tipoData"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const isUnico = e.target.value === 'unico';
            elementos.dataUnica.classList.toggle('hidden', !isUnico);
            elementos.dataIntervalo.classList.toggle('hidden', isUnico);
        });
    });

    elementos.temHorarioDefinido.addEventListener('change', (e) => {
        const show = e.target.value === 'Sim';
        elementos.horariosContainer.classList.toggle('hidden', !show);
    });

    document.querySelectorAll('input[name="tipoHorario"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const isUnico = e.target.value === 'unico';
            elementos.horarioUnico.classList.toggle('hidden', !isUnico);
            elementos.horarioIntervalo.classList.toggle('hidden', isUnico);
        });
    });

    elementos.joinville.addEventListener('change', (e) => {
        const isNaoJoinville = e.target.value === 'Não';
        elementos.cidadeOutras.classList.toggle('hidden', !isNaoJoinville);
        elementos.outraCidade.required = isNaoJoinville;
        
        if (elementos.sessao2.offsetParent !== null) {
            elementos.bairrosJoinvilleContainer.classList.toggle('hidden', isNaoJoinville);
            elementos.outrosBairrosContainer.classList.toggle('hidden', !isNaoJoinville);
            elementos.bairros.required = !isNaoJoinville;
            elementos.outrosBairros.required = isNaoJoinville;
        }
    });

    elementos.impulsionar.addEventListener('change', async (e) => {
        const impulsionar = e.target.value === 'Sim';
        elementos.btnContinuar.style.display = impulsionar ? 'flex' : 'none';
        elementos.btnFinalizarPDF.style.display = impulsionar ? 'none' : 'flex';

        if (!impulsionar && elementos.sessao2.classList.contains('active')) {
             const result = await Swal.fire({
                title: 'Atenção',
                text: 'Ao desativar o impulsionamento, os dados da Sessão 2 serão perdidos. Deseja continuar?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, limpar',
                cancelButtonText: 'Não, manter'
            });
            if (result.isConfirmed) {
                limparSessao2();
            } else {
                e.target.value = 'Sim';
                elementos.btnContinuar.style.display = 'flex';
                elementos.btnFinalizarPDF.style.display = 'none';
            }
        }
        checkBoostDateWarning();
    });

    elementos.form.querySelectorAll('input, select, textarea').forEach(input => {
       input.addEventListener('input', (e) => {
            if (e.target.classList.contains('invalid')) {
                e.target.classList.remove('invalid');
            }
        });
    });

    elementos.whatsapp.addEventListener('input', mascaras.aplicarMascaraTelefone);
    elementos.orcamento.addEventListener('input', mascaras.aplicarMascaraValor);

    elementos.idadeMinima.addEventListener('change', () => {
        if (parseInt(elementos.idadeMaxima.value) < parseInt(elementos.idadeMinima.value)) {
            elementos.idadeMaxima.value = elementos.idadeMinima.value;
        }
    });
     elementos.idadeMaxima.addEventListener('change', () => {
        if (parseInt(elementos.idadeMaxima.value) < parseInt(elementos.idadeMinima.value)) {
            elementos.idadeMinima.value = elementos.idadeMaxima.value;
        }
    });

    window.adicionarData = () => {
        const div = document.createElement('div');
        div.className = 'campo-data flex items-center mb-2';
        div.innerHTML = `
            <label class="mr-2">Data:</label>
            <input type="date" name="datas[]" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="remove-btn ml-2" onclick="removerData(this)"><i class="fas fa-times"></i></span>
        `;
        elementos.datasUnicas.appendChild(div);
    };
    window.removerData = (el) => el.parentElement.remove();

    window.adicionarIntervalo = () => {
        const div = document.createElement('div');
        div.className = 'campo-intervalo grid grid-cols-5 gap-2 items-center mb-2';
        div.innerHTML = `
            <label>De</label>
            <input type="date" name="dataInicio[]" class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <label>até</label>
            <input type="date" name="dataFim[]" class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="remove-btn ml-2" onclick="removerIntervalo(this)"><i class="fas fa-times"></i></span>
        `;
        elementos.datasIntervalos.appendChild(div);
    };
    window.removerIntervalo = (el) => el.parentElement.remove();
    
    window.adicionarHorario = () => {
        const div = document.createElement('div');
        div.className = 'campo-horario flex items-center mb-2';
        div.innerHTML = `
            <label class="mr-2">Horário:</label>
            <input type="time" name="horarios[]" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="remove-btn ml-2" onclick="removerHorario(this)"><i class="fas fa-times"></i></span>
        `;
        elementos.horariosUnicos.appendChild(div);
    };
    window.removerHorario = (el) => el.parentElement.remove();

    window.adicionarHorarioIntervalo = () => {
        const div = document.createElement('div');
        div.className = 'campo-intervalo-horario grid grid-cols-5 gap-2 items-center mb-2';
        div.innerHTML = `
            <label>Das</label>
            <input type="time" name="horaInicio[]" class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <label>às</label>
            <input type="time" name="horaFim[]" class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="remove-btn ml-2" onclick="removerHorarioIntervalo(this)"><i class="fas fa-times"></i></span>
        `;
        elementos.horariosIntervalos.appendChild(div);
    };
    window.removerHorarioIntervalo = (el) => el.parentElement.remove();


    elementos.btnContinuar.addEventListener('click', () => {
        if (validacao.validarSessao(1)) {
            navigateTo('sessao2');
            checkBoostDateWarning();
        }
    });

    window.voltarSessao = (numSessao) => {
        navigateTo(`sessao${numSessao}`);
    };

    elementos.btnFinalizarPDF.addEventListener('click', () => {
        if (validacao.validarSessao(1)) {
            gerarPdfEAbriWebmail();
        }
    });

    elementos.btnSalvarPDF.addEventListener('click', () => {
        if (validacao.validarSessao(1) && validacao.validarSessao(2)) {
            gerarPdfEAbriWebmail();
        }
    });

    function limparSessao2() {
        elementos.sessao2.querySelectorAll('input, select').forEach(input => {
            if(input.type === 'number' || input.type === 'text') input.value = '';
            if(input.tagName === 'SELECT') input.selectedIndex = 0;
            input.classList.remove('valid', 'invalid');
        });
        elementos.idadeMinima.value = "18";
        elementos.idadeMaxima.value = "55";
        elementos.dias.value = "4";
        elementos.orcamento.value = "R$50,00";
        elementos.genero.value = "Ambos";
    }

    function checkBoostDateWarning() {
        let showWarning = false;
        if (elementos.impulsionar.value === 'Sim' && elementos.temDataDefinida.value === 'Sim') {
            const hoje = new Date();
            const limite = new Date(hoje.setDate(hoje.getDate() + 4));
            
            const datas = document.querySelectorAll('input[name="datas[]"], input[name="dataInicio[]"]');
            datas.forEach(input => {
                if (input.value) {
                    const dataSelecionada = new Date(input.value + "T00:00:00");
                    if (dataSelecionada <= limite) {
                        showWarning = true;
                    }
                }
            });
        }
        elementos.avisoImpulsionamento.classList.toggle('hidden', !showWarning);
        if (elementos.sessao2.classList.contains('active')) {
            elementos.avisoImpulsionamento4dias.classList.toggle('hidden', !showWarning);
        }
    }
    
    elementos.bairroSearch.addEventListener('input', (e) => {
        const termo = e.target.value.toLowerCase();
        const options = elementos.bairros.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            const optgroup = option.parentElement;
            
            const textoOpcao = option.text.toLowerCase();
            const corresponde = textoOpcao.includes(termo);
            option.style.display = corresponde ? '' : 'none';
        }

        const optgroups = elementos.bairros.getElementsByTagName('optgroup');
        for (let i = 0; i < optgroups.length; i++) {
            const optgroup = optgroups[i];
            const opcoesVisiveis = optgroup.querySelectorAll('option[style=""]');
            optgroup.style.display = opcoesVisiveis.length > 0 ? '' : 'none';
        }
    });

    async function gerarPdfEAbriWebmail() {
        Swal.fire({
            title: 'Gerando PDF...',
            text: 'Aguarde um momento.',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        try {
            const { PDFDocument, StandardFonts, rgb } = window.PDFLib;
            const pdfDoc = await PDFDocument.create();
            const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            let page = pdfDoc.addPage();
            
            const { width, height } = page.getSize();
            const fontSize = 10;
            const margin = 50;
            let y = height - margin;

            const checkY = (spaceNeeded) => {
                if (y - spaceNeeded < margin) {
                    page = pdfDoc.addPage();
                    y = height - margin;
                }
            };

            const writeSectionHeader = (text) => {
                checkY(40);
                y -= 20;
                page.drawText(text, {
                    x: margin,
                    y: y,
                    font: helveticaBold,
                    size: 14,
                    color: rgb(0.1, 0.4, 0.7)
                });
                y -= 10;
                page.drawLine({
                    start: { x: margin, y: y },
                    end: { x: width - margin, y: y },
                    thickness: 1,
                    color: rgb(0.8, 0.8, 0.8),
                })
                y-= 10;
            };

            const writeField = (label, value) => {
                if (!value || value.trim() === '') return; 
                
                checkY(20);
                y -= 15;
                page.drawText(`${label}:`, {
                    x: margin,
                    y: y,
                    font: helveticaBold,
                    size: fontSize,
                    color: rgb(0.2, 0.2, 0.2), 
                });

                checkY(20); 
                y -= 15;

                const valueX = margin + 15;
                const maxWidth = width - valueX - margin;
                
                const words = String(value).split(' ');
                let line = '';
                for (const word of words) {
                    const testLine = line + word + ' ';
                    const textWidth = helvetica.widthOfTextAtSize(testLine, fontSize);
                    if (textWidth > maxWidth && line.length > 0) {
                        page.drawText(line, { x: valueX, y: y, font: helvetica, size: fontSize, color: rgb(0.1, 0.1, 0.1) });
                        checkY(15);
                        y -= 12; 
                        line = word + ' ';
                    } else {
                        line = testLine;
                    }
                }
                page.drawText(line.trim(), { x: valueX, y: y, font: helvetica, size: fontSize, color: rgb(0.1, 0.1, 0.1) });
            };
            
            const getLabelFor = (elementId) => {
                const label = document.querySelector(`label[for="${elementId}"]`);
                if (label) {
                    const clone = label.cloneNode(true);
                    clone.querySelectorAll('span').forEach(s => s.remove());
                    return clone.textContent.trim();
                }
                return elementId;
            };

            writeSectionHeader("Sessão 1 - Dados da Vaga");
            
            const fieldsSessao1 = ['unidadeRH', 'cargo', 'codigoVaga', 'analista', 'whatsapp', 'divulgaLogo', 'empresa', 'producao', 'presencial', 'local', 'evento', 'recorrente', 'mediaMensal', 'tipoVaga', 'vagas', 'beneficios', 'requisitos', 'turnos', 'joinville', 'outraCidade', 'notas', 'impulsionar'];
            fieldsSessao1.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value) {
                    writeField(getLabelFor(id), el.value);
                }
            });

            if(elementos.temDataDefinida.value === 'Sim') {
                const tipoData = document.querySelector('input[name="tipoData"]:checked').value;
                let datasStr = '';
                if (tipoData === 'unico') {
                    const datas = [...document.querySelectorAll('input[name="datas[]"]')].map(d => d.value).filter(Boolean);
                    datasStr = datas.join(', ');
                } else {
                    const intervalos = [...document.querySelectorAll('#datasIntervalos .campo-intervalo')].map(i => {
                        const start = i.querySelector('input[name="dataInicio[]"]').value;
                        const end = i.querySelector('input[name="dataFim[]"]').value;
                        return (start && end) ? `de ${start} até ${end}` : null;
                    }).filter(Boolean);
                    datasStr = intervalos.join('; ');
                }
                if(datasStr) writeField('Datas Definidas', datasStr);

            } else {
                writeField('Datas Definidas', 'Não (Padrão: Segunda à Sexta)');
            }

            if(elementos.temHorarioDefinido.value === 'Sim') {
                const tipoHorario = document.querySelector('input[name="tipoHorario"]:checked').value;
                let horariosStr = '';
                if(tipoHorario === 'unico') {
                    const horarios = [...document.querySelectorAll('input[name="horarios[]"]')].map(h => h.value).filter(Boolean);
                    horariosStr = horarios.join(', ');
                } else {
                    const intervalos = [...document.querySelectorAll('#horariosIntervalos .campo-intervalo-horario')].map(i => {
                        const start = i.querySelector('input[name="horaInicio[]"]').value;
                        const end = i.querySelector('input[name="horaFim[]"]').value;
                        return (start && end) ? `das ${start} às ${end}` : null;
                    }).filter(Boolean);
                    horariosStr = intervalos.join('; ');
                }
                if(horariosStr) writeField('Horários Definidos', horariosStr);
            } else {
                writeField('Horários Definidos', 'Não (Padrão: 7:30 às 17:00)');
            }


            if (elementos.impulsionar.value === 'Sim') {
                writeSectionHeader("Sessão 2 - Impulsionamento");
                const fieldsSessao2 = ['genero', 'idadeMinima', 'idadeMaxima', 'dias', 'orcamento'];
                fieldsSessao2.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value) {
                        let value = el.value;
                        if(id === 'idadeMinima' || id === 'idadeMaxima') {
                            value = `${el.value} anos`;
                        }
                        writeField(getLabelFor(id), value);
                    }
                });

                if (elementos.joinville.value === 'Sim') {
                    const bairrosSelecionados = [...elementos.bairros.selectedOptions].map(o => o.text).join(', ');
                    writeField('Bairros (Joinville)', bairrosSelecionados);
                } else {
                    writeField('Bairros (Outra Cidade)', elementos.outrosBairros.value);
                }
            }
            
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Vaga_${elementos.cargo.value.replace(/[\s/\\?%*:"|<>]/g, '_')}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            await Swal.fire({
                icon: 'success',
                title: 'PDF Gerado!',
                text: 'O arquivo PDF foi baixado. O webmail será aberto em seguida para você anexá-lo.',
                timer: 2500,
                showConfirmButton: false
            });

            if (!webmailWindow || webmailWindow.closed) {
                webmailWindow = window.open('https://webmail.rhbrasil.com.br/', '_blank');
            } else {
                webmailWindow.focus();
            }
        
        } catch(error) {
            Swal.close();
        }
    }

    // --- Lógica de Busca de Vagas ---
    let allVacanciesData = [];
    let isOnlineMode = true;

    async function initVacancySearch() {
        try {
            const response = await fetch('https://www.rhbrasil.com.br/uploads/portal_candidato/vagas-publicas.json');
            if (!response.ok) {
                throw new Error();
            }
            const data = await response.json();
            allVacanciesData = data;
            
            let unidades = [...new Set(data.map(u => u.UNIDADE_RHBRASIL).filter(Boolean))];
            
            const joinvilleUnidade = "JOINVILLE/SC";
            const joinvilleIndex = unidades.indexOf(joinvilleUnidade);
            
            if (joinvilleIndex > -1) {
                unidades.splice(joinvilleIndex, 1);
            } 
            unidades.sort();
            unidades.unshift(joinvilleUnidade);
            
            elementos.unidadeRH.innerHTML = ''; // Limpa o "carregando"
            unidades.forEach(u => {
                const option = document.createElement('option');
                option.value = u;
                option.textContent = u;
                elementos.unidadeRH.appendChild(option);
            });
            
            elementos.unidadeRH.value = joinvilleUnidade;
            elementos.unidadeRH.dispatchEvent(new Event('change'));

        } catch (error) {
            isOnlineMode = false;
            elementos.unidadeContainer.classList.add('hidden');
            elementos.unidadeRH.required = false;
            elementos.offlineDescriptionContainer.classList.remove('hidden');
        }
    }

    function performSearch() {
        if (!isOnlineMode) return;
        const query = elementos.cargo.value.toLowerCase().trim();
        const selectedUnidade = elementos.unidadeRH.value;
        
        if (!query || !selectedUnidade || allVacanciesData.length === 0) {
            elementos.searchResults.classList.add('hidden');
            return;
        }

        const unidadeData = allVacanciesData.find(u => u.UNIDADE_RHBRASIL === selectedUnidade);
        if (!unidadeData || !unidadeData.LOCAIS_ATUACAO) {
            elementos.searchResults.classList.add('hidden');
            return;
        }

        const results = unidadeData.LOCAIS_ATUACAO.flatMap(local => 
            local.VAGAS ? local.VAGAS.map(vaga => ({...vaga, LOCAL_ATUACAO: local.LOCAL_ATUACAO})) : []
        ).filter(vaga => 
            vaga.NOME_VAGA.toLowerCase().includes(query) || 
            String(vaga.CODIGO_VAGA).includes(query)
        );

        displayResults(results);
    }

    function displayResults(results) {
        elementos.searchResults.innerHTML = '';
        if (results.length === 0) {
            elementos.searchResults.classList.add('hidden');
            return;
        }

        results.slice(0, 10).forEach(vaga => { // Limita a 10 resultados para performance
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
                <div>${vaga.NOME_VAGA}</div>
                <div class="vacancy-code">${vaga.CODIGO_VAGA} - ${vaga.LOCAL_ATUACAO}</div>
            `;
            item.addEventListener('click', () => selectVacancy(vaga));
            elementos.searchResults.appendChild(item);
        });

        elementos.searchResults.classList.remove('hidden');
    }
    
    async function parseWithGemini(text) {
        const apiKey = "";
        
        let timerInterval;
        Swal.fire({
            title: 'Analisando com Recrutinha IA...',
            html: `
                <p>Aguarde, isso pode levar alguns segundos.</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                    <div id="gemini-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            `,
            timerProgressBar: false,
            allowOutsideClick: false,
            didOpen: () => {
                const progressBar = Swal.getHtmlContainer()?.querySelector('#gemini-progress-bar');
                let progress = 0;
                timerInterval = setInterval(() => {
                    progress += 5; 
                    if(progress < 95) {
                         if(progressBar) progressBar.style.width = progress + '%';
                    }
                }, 100);
            },
            willClose: () => {
                clearInterval(timerInterval);
            }
        });

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const prompt = `Analise o seguinte texto de descrição de uma vaga de emprego. Extraia as informações de "requisitos", "benefícios", "turno" e "notas adicionais". Formate a saída como um objeto JSON com as chaves "requisitos", "beneficios", "turno" e "notas". Se uma seção não for encontrada, retorne uma string vazia para a chave correspondente. Texto da vaga: "${text}"`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "requisitos": { "type": "STRING" },
                        "beneficios": { "type": "STRING" },
                        "turno": { "type": "STRING" },
                        "notas": { "type": "STRING" }
                    },
                    required: ["requisitos", "beneficios", "turno", "notas"]
                }
            }
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error();
            const result = await response.json();
            
            clearInterval(timerInterval);
            const progressBar = Swal.getHtmlContainer()?.querySelector('#gemini-progress-bar');
            if (progressBar) progressBar.style.width = '100%';

            const candidate = result.candidates?.[0];
            const content = candidate?.content?.parts?.[0]?.text;
            
            return content ? JSON.parse(content) : null;

        } catch (error) {
            Swal.close();
            return null;
        }
    }


    async function selectVacancy(vaga) {
        elementos.cargo.value = vaga.NOME_VAGA;
        elementos.codigoVaga.value = vaga.CODIGO_VAGA;
        elementos.searchResults.classList.add('hidden');
        
        if (vaga.LOCAL_ATUACAO) {
            if (vaga.LOCAL_ATUACAO.toUpperCase().includes('JOINVILLE')) {
                elementos.joinville.value = 'Sim';
            } else {
                elementos.joinville.value = 'Não';
                elementos.outraCidade.value = vaga.LOCAL_ATUACAO.split('/')[0].trim();
            }
            elementos.joinville.dispatchEvent(new Event('change'));
        }

        try {
            const response = await fetch(`https://www.rhbrasil.com.br/portaldocandidato/view/ver-vagas.php?cod=${vaga.CODIGO_VAGA}`);
            if (!response.ok) {
                 throw new Error();
            }
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            
            const descriptionDiv = doc.querySelector('.description.expand') || doc.body;
            const vacancyText = descriptionDiv.innerText;

            if (/os detalhes dessa vaga ainda não foram divulgados/i.test(vacancyText)) {
                elementos.offlineDescriptionContainer.classList.remove('hidden');
                elementos.descricaoVaga.value = vacancyText;
                Swal.close();
                return;
            }

            const parsedData = await parseWithGemini(vacancyText);

            if (parsedData) {
                elementos.requisitos.value = parsedData.requisitos || '';
                elementos.beneficios.value = parsedData.beneficios || '';
                elementos.turnos.value = parsedData.turno || '';
                elementos.notas.value = parsedData.notas || '';
                Swal.fire('Sucesso!', 'Os detalhes da vaga foram carregados e analisados pela IA!', 'success');
            } else {
                Swal.fire('Análise Falhou', 'Não foi possível extrair os dados do texto. Por favor, preencha manualmente.', 'warning');
            }
            
            if (descriptionDiv.textContent.toLowerCase().includes('temporári')) {
                elementos.tipoVaga.value = 'Temporário';
            } else {
                 elementos.tipoVaga.value = 'Efetivo';
            }

        } catch (error) {
            Swal.close();
            elementos.offlineDescriptionContainer.classList.remove('hidden');
        }
    }

    elementos.geminiParseBtn.addEventListener('click', async () => {
        const textToParse = elementos.descricaoVaga.value;
        if (!textToParse.trim()) {
            Swal.fire('Texto Vazio', 'Cole a descrição da vaga no campo apropriado para análise.', 'info');
            return;
        }
        
        const parsedData = await parseWithGemini(textToParse);

        if (parsedData) {
            elementos.requisitos.value = parsedData.requisitos || '';
            elementos.beneficios.value = parsedData.beneficios || '';
            elementos.turnos.value = parsedData.turno || '';
            elementos.notas.value = parsedData.notas || '';
            Swal.fire('Sucesso!', 'O texto foi analisado e os campos foram preenchidos!', 'success');
        } else {
            Swal.fire('Análise Falhou', 'Não foi possível extrair os dados do texto. Por favor, preencha manualmente.', 'warning');
        }
    });

    elementos.cargo.addEventListener('input', performSearch);
    elementos.unidadeRH.addEventListener('change', performSearch);
    document.addEventListener('click', (e) => {
        if (elementos.searchResults && !elementos.searchResults.contains(e.target) && e.target !== elementos.cargo) {
            elementos.searchResults.classList.add('hidden');
        }
    });
    
    // Inicia a busca de vagas
    initVacancySearch();
    updateProgress(1);
});
</script>
</body>
</html>
